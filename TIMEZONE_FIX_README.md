# إصلاح مشكلة المنطقة الزمنية في نظام الفعاليات

## المشكلة
كانت هناك مشكلة في عرض التوقيت في نظام الفعاليات حيث:
- Supabase يحفظ التواريخ بـ UTC
- المستخدمون في السعودية (UTC+3)
- كان هناك عدم تطابق في عرض الأوقات

## الحل المطبق

### 1. إنشاء ملف المساعدات للمنطقة الزمنية
تم إنشاء `src/utils/timezone.ts` الذي يحتوي على:
- دوال لتحويل UTC إلى التوقيت السعودي
- دوال لتنسيق التاريخ والوقت بالعربية
- دوال للتحقق من حالة الفعاليات

### 2. تحديث عرض التواريخ والأوقات
تم تحديث الصفحات التالية لاستخدام التوقيت السعودي:
- `src/pages/WeeklyEvents.tsx` - صفحة الفعاليات للمستخدمين
- `src/pages/AdminWeeklyEvents.tsx` - صفحة إدارة الفعاليات
- `src/hooks/useWeeklyEvents.ts` - Hook للتعامل مع الفعاليات

### 3. إضافة خيار تغيير حالة الفعالية
تم إضافة إمكانية للأدمن لتغيير حالة الفعالية من:
- `finished` إلى `upcoming`
- `upcoming` إلى `active`
- `active` إلى `finished`

### 4. تحديث قاعدة البيانات
تم إنشاء `fix_timezone_events.sql` الذي يحتوي على:
- دالة لتغيير حالة الفعالية يدوياً
- View لعرض الفعاليات بالتوقيت السعودي
- دوال مساعدة للتعامل مع المنطقة الزمنية

## كيفية تطبيق الإصلاحات

### 1. تطبيق تحديثات قاعدة البيانات
```sql
-- تشغيل الملف في Supabase SQL Editor
\i fix_timezone_events.sql
```

### 2. إعادة تشغيل التطبيق
```bash
npm run dev
```

## الميزات الجديدة

### للأدمن:
1. **تغيير حالة الفعالية**: يمكن للأدمن الآن تغيير حالة أي فعالية من خلال أزرار في صفحة إدارة الفعاليات
2. **عرض التوقيت الصحيح**: جميع الأوقات تظهر الآن بالتوقيت السعودي

### للمستخدمين:
1. **عرض التوقيت الصحيح**: جميع الأوقات تظهر بالتوقيت السعودي
2. **حساب دقيق للوقت المتبقي**: العد التنازلي يعمل بناءً على التوقيت السعودي

## الدوال الجديدة

### في `src/utils/timezone.ts`:
- `formatSaudiDate()` - تنسيق التاريخ بالعربية والتوقيت السعودي
- `formatSaudiTime()` - تنسيق الوقت بالعربية والتوقيت السعودي
- `formatSaudiDateTime()` - تنسيق التاريخ والوقت معاً
- `getTimeRemainingInSaudiTime()` - حساب الوقت المتبقي بالتوقيت السعودي

### في `src/hooks/useWeeklyEvents.ts`:
- `changeEventStatus()` - تغيير حالة الفعالية

## اختبار الإصلاحات

### 1. اختبار عرض التوقيت:
- تحقق من أن الأوقات تظهر بالتوقيت السعودي في صفحة الفعاليات
- تحقق من أن العد التنازلي يعمل بشكل صحيح

### 2. اختبار تغيير حالة الفعالية:
- اذهب إلى صفحة إدارة الفعاليات كأدمن
- جرب تغيير حالة فعالية من "منتهي" إلى "قادم"
- تحقق من أن التغيير يظهر فوراً

### 3. اختبار قاعدة البيانات:
```sql
-- اختبار الدالة الجديدة
SELECT change_event_status(1, 'upcoming');

-- اختبار العرض الجديد
SELECT * FROM weekly_events_saudi_time;
```

## ملاحظات مهمة

1. **جميع التواريخ في قاعدة البيانات تبقى بـ UTC** - هذا هو الأسلوب الصحيح
2. **التحويل للتوقيت السعودي يحدث فقط عند العرض** - باستخدام `timeZone: 'Asia/Riyadh'`
3. **الدوال الجديدة متوافقة مع المتصفحات الحديثة** - تستخدم `Intl.DateTimeFormat`

## استكشاف الأخطاء

### إذا لم تظهر الأوقات بشكل صحيح:
1. تحقق من أن المتصفح يدعم `timeZone: 'Asia/Riyadh'`
2. تحقق من إعدادات المنطقة الزمنية في النظام
3. امسح cache المتصفح وأعد تحميل الصفحة

### إذا لم تعمل دالة تغيير حالة الفعالية:
1. تحقق من أن الملف `fix_timezone_events.sql` تم تطبيقه في قاعدة البيانات
2. تحقق من صلاحيات المستخدم في Supabase
3. راجع console المتصفح للأخطاء
